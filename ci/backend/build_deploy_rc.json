{
    "timeout": "3600s",
    "steps": [
        {
            "name": "gcr.io/cloud-builders/git",
            "secretEnv": ["PATCH_SSH_KEY", "INFRA_SSH_KEY"],
            "entrypoint": "bash",
            "args": [
                "-c",
                "echo \"$$PATCH_SSH_KEY\" >> /root/.ssh/patch_rsa\n echo \"$$INFRA_SSH_KEY\" >> /root/.ssh/infra_rsa\n chmod 600 /root/.ssh/patch_rsa\n chmod 600 /root/.ssh/infra_rsa\n ssh-keyscan -t rsa github.com > known_hosts.github\n cp known_hosts.github /root/.ssh/known_hosts\n cp ci/common/ssh_config /root/.ssh/config"
            ],
            "volumes": [{
                "name": "ssh",
                "path": "/root/.ssh"
            }]
        },
        {
            "name": "gcr.io/cloud-builders/git",
            "args": [
                "config",
                "--file=.gitmodules", 
                "submodule.backend/infra.url",
                "infra:Raheem-ai/raheem-infra.git"
            ],
            "volumes": [{
                "name": "ssh",
                "path": "/root/.ssh"
            }]
        },
        {
            "name": "gcr.io/cloud-builders/git",
            "args": [
                "submodule",
                "update", 
                "--init"
            ],
            "volumes": [{
                "name": "ssh",
                "path": "/root/.ssh"
            }]
        },
        {
            "name": "gcr.io/cloud-builders/git",
            "entrypoint": "bash",
            "args": [
                "ci/common/generate_changed_files.sh"
            ],
            "volumes": [{
                "name": "ssh",
                "path": "/root/.ssh"
            }],
            "env": [
                "SHORT_SHA=$SHORT_SHA",
                "COMMIT_SHA=$COMMIT_SHA"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/docker",
            "entrypoint": "bash",
            "args": [
                "ci/backend/build_rc.sh"
            ],
            "env": [
                "PROJECT_ID=$PROJECT_ID",
                "SHORT_SHA=$SHORT_SHA",
                "_MERGED_BRANCH=$_MERGED_BRANCH"
            ]
        },
        {
            "name": "gcr.io/$PROJECT_ID/patch-rc:$SHORT_SHA",
            "entrypoint": "bash",
            "args": [
                "/app/ci/backend/generate_rc_config.sh"
            ],
            "env": [ 
                "_ENVIRONMENT=$_ENVIRONMENT"
            ]
        },
        {
            "name": "gcr.io/$PROJECT_ID/patch-rc:$SHORT_SHA",
            "entrypoint": "bash",
            "args": [
                "/app/ci/backend/run_migrations.sh"
            ],
            "env": [ 
                "_ENVIRONMENT=$_ENVIRONMENT",
                "MONGO_CREDS=$MONGO_CREDS"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/gcloud",
            "entrypoint": "bash",
            "args": [
                "ci/backend/deploy_rc.sh"
            ],
            "volumes": [{
                "name": "ssh",
                "path": "/root/.ssh"
            }],
            "env": [
                "PROJECT_ID=$PROJECT_ID",
                "COMMIT_SHA=$COMMIT_SHA",
                "SHORT_SHA=$SHORT_SHA",
                "_MERGED_SHA=$_MERGED_SHA",
                "_SERVICE=$_SERVICE", 
                "_CI_EMAIL=$_CI_EMAIL",
                "_CI_USERNAME=$_CI_USERNAME"
            ]
        },
        {
            "name": "gcr.io/$PROJECT_ID/patch-rc:$SHORT_SHA",
            "entrypoint": "bash",
            "args": [
                "/app/ci/backend/revert_migrations.sh"
            ],
            "env": [ 
                "_ENVIRONMENT=$_ENVIRONMENT",
                "MONGO_CREDS=$MONGO_CREDS"
            ]
        },
        {
            "name": "gcr.io/$PROJECT_ID/patch-rc:$SHORT_SHA",
            "entrypoint": "bash",
            "secretEnv": ["EXPO_TOKEN", "GOOGLE_MAPS", "SENTRY_CREDS"],
            "args": [
                "/app/ci/frontend/publish.sh"
            ],
            "env": [
                "PROJECT_ID=$PROJECT_ID",
                "COMMIT_SHA=$COMMIT_SHA",
                "_MERGED_SHA=$_MERGED_SHA",
                "_ENVIRONMENT=$_ENVIRONMENT"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/gcloud",
            "entrypoint": "bash",
            "args": [
                "ci/backend/gc.sh"
            ],
            "env": [
                "PROJECT_ID=$PROJECT_ID",
                "BRANCH_NAME=$BRANCH_NAME"
            ]
        }
    ],
    "availableSecrets": {
        "secretManager": [
            {
                "versionName": "projects/$PROJECT_ID/secrets/google-maps/versions/latest",
                "env": "GOOGLE_MAPS"
            },
            {
                "versionName": "projects/$PROJECT_ID/secrets/sentry-creds/versions/latest",
                "env": "SENTRY_CREDS"
            },
            {
                "versionName": "projects/$PROJECT_ID/secrets/patch-mongo-credentials/versions/latest",
                "env": "MONGO_CREDS"
            },
            {
                "versionName": "projects/$PROJECT_ID/secrets/infra-git-ssh-key/versions/latest",
                "env": "INFRA_SSH_KEY"
            },
            {
                "versionName": "projects/$PROJECT_ID/secrets/patch-git-ssh-key/versions/latest",
                "env": "PATCH_SSH_KEY"
            },
            {
                "versionName": "projects/$PROJECT_ID/secrets/expo-build-deploy-bot-secret/versions/latest",
                "env": "EXPO_TOKEN"
            }
        ] 
    }
}