{
    "timeout": "3600s",
    "steps": [
        {
            "name": "gcr.io/cloud-builders/docker",
            "entrypoint": "bash",
            "args": [
                "ci/backend/promote_release_image.sh"
            ],
            "env": [
                "PROJECT_ID=$PROJECT_ID",
                "TARGET_COMMIT=$_TARGET_COMMIT"
            ]
        },
        {
            "name": "gcr.io/$PROJECT_ID/patch-rel-prod:$_TARGET_COMMIT",
            "entrypoint": "bash",
            "args": [
                "/app/ci/backend/generate_release_config.sh"
            ],
            "env": [ 
                "_ENVIRONMENT=prod"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/gcloud",
            "entrypoint": "bash",
            "args": [
                "ci/backend/deploy_prod.sh"
            ],
            "env": [
                "PROJECT_ID=$PROJECT_ID",
                "TARGET_COMMIT=$_TARGET_COMMIT",
                "_SERVICE=patch-api"
            ]
        },
        {
            "name": "gcr.io/cloud-builders/git",
            "secretEnv": ["GOOGLE_APPLICATION_CREDENTIALS"],
            "entrypoint": "bash",
            "args": [
                "-c",
                "echo \"$$GOOGLE_APPLICATION_CREDENTIALS\" >> /workspace/google-adc\n"
            ]
        },
        {
            "name": "gcr.io/$PROJECT_ID/patch-rel-prod:$_TARGET_COMMIT",
            "entrypoint": "bash",
            "secretEnv": ["MONGO_CREDS"],
            "args": [
                "/app/ci/frontend/update_dynamic_config_prod.sh"
            ],
            "env": [
                "GOOGLE_APPLICATION_CREDENTIALS=/workspace/google-adc"
            ]
        }
    ],
    "availableSecrets": {
        "secretManager": [
            {
                "versionName": "projects/$PROJECT_ID/secrets/patch-mongo-credentials/versions/latest",
                "env": "MONGO_CREDS"
            },
            {
                "versionName": "projects/$PROJECT_ID/secrets/google-adc/versions/latest",
                "env": "GOOGLE_APPLICATION_CREDENTIALS"
            }
        ] 
    }
}