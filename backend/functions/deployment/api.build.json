{
    "timeout": "1200s",
    "steps": [
    {
        "name": "gcr.io/cloud-builders/git",
        "secretEnv": ["SSH_KEY"],
        "entrypoint": "bash",
        "args": [
            "-c",
            "echo \"$$SSH_KEY\" >> /root/.ssh/id_rsa\n chmod 600 /root/.ssh/id_rsa\n ssh-keyscan -t rsa github.com > known_hosts.github\n cp known_hosts.github /root/.ssh/known_hosts"
        ],
        "volumes": [{
            "name": "ssh",
            "path": "/root/.ssh"
        }]
    },
    {
        "name": "gcr.io/cloud-builders/git",
        "args": [
            "config",
            "--file=.gitmodules", 
            "submodule.backend/functions/infra.url",
            "git@github.com:Raheem-ai/raheem-infra.git"
        ],
        "volumes": [{
            "name": "ssh",
            "path": "/root/.ssh"
        }]
    },
    {
        "name": "gcr.io/cloud-builders/git",
        "args": [
            "submodule",
            "update", 
            "--init"
        ],
        "volumes": [{
            "name": "ssh",
            "path": "/root/.ssh"
        }]
    },
    {
        "name": "gcr.io/cloud-builders/docker",
        "args": [
            "build",
            "-t",
            "gcr.io/$PROJECT_ID/patch:rc-$SHORT_SHA",
            "-t",
            "gcr.io/$PROJECT_ID/patch:rc-latest",
            "-f",
            "api.dockerfile",
            "--cache-from",
            "gcr.io/$PROJECT_ID/patch:rc-latest",
            "."
         ]
    },
    {
        "name": "gcr.io/cloud-builders/docker",
        "args": [
            "push",
            "gcr.io/$PROJECT_ID/patch:rc-$SHORT_SHA"
        ]
    },
    {
        "name": "gcr.io/cloud-builders/docker",
        "args": [
            "push",
            "gcr.io/$PROJECT_ID/patch:rc-latest"
        ]
    },
    {
        "name": "gcr.io/$PROJECT_ID/patch:rc-$SHORT_SHA",
        "entrypoint": "/app/backend/functions/infra/bin/run",
        "args": [
            "config:generate",
            "-e",
            "$_ENVIRONMENT",
            "--toFile",
            "secretConfig.txt",
            "--secretVersionList",
            "--noComments"
        ]
    },
    {
        "name": "gcr.io/$PROJECT_ID/patch:rc-$SHORT_SHA",
        "entrypoint": "/app/backend/functions/infra/bin/run",
        "args": [
            "config:generate",
            "-e",
            "$_ENVIRONMENT",
            "--toFile",
            "config.txt",
            "--delim=##",
            "--configList",
            "--noComments"
        ]
    },
    {
        "name": "gcr.io/cloud-builders/gcloud",
        "entrypoint": "bash",
        "args": [
            "-c",
            "gcloud beta run deploy $_SERVICE --image=gcr.io/$PROJECT_ID/patch:rc-$SHORT_SHA --region=us-central1 --set-secrets=$(cat secretConfig.txt) --set-env-vars=^##^$(cat config.txt)"
        ]
    },
    {
        "name": "gcr.io/cloud-builders/gcloud",
        "entrypoint": "bash",
        "args": [
            "backend/functions/deployment/gc.sh"
        ]
    }],
    "availableSecrets": {
        "secretManager": [
            {
                "versionName": "projects/$PROJECT_ID/secrets/infra-git-ssh-key/versions/latest",
                "env": "SSH_KEY"
            }
        ] 
    }
}